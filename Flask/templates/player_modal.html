<div class="modal fade" id="player-modal" tabindex="-1" aria-labelledby="player-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="player-modal-label">Player profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <img id="player-headshot"
                        src=""
                        alt=""
                        class="player-headshot"
                        style="display: none;">
                    <div>
                        <div id="player-name" class="player-name"></div>
                        <div id="player-details" class="tag-row"></div>
                        <div id="player-injury" class="mt-2"></div>
                        <div class="player-meta mt-2">Player ID: <span id="player-modal-id"></span></div>
                    </div>
                </div>

                <div id="stats-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <div id="stats-error" class="text-danger" style="display: none;"></div>

                <div id="stats-table" class="table-responsive stats-table opacity-0" style="transition: opacity 0.3s ease-in-out;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>MIN</th>
                                <th>PTS</th>
                                <th>REB</th>
                                <th>AST</th>
                                <th>STL</th>
                                <th>BLK</th>
                                <th>TO</th>
                                <th>FG%</th>
                            </tr>
                        </thead>
                        <tbody id="stats-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    function formatGameDate(gameId) {
        const date = gameId.substring(0, 8);
        return `${date.substring(4, 6)}/${date.substring(6, 8)}/${date.substring(2, 4)}`;
    }

    function resetModalState() {
        document.getElementById('stats-loading').style.display = 'block';
        const statsTable = document.getElementById('stats-table');
        statsTable.style.display = 'none';
        statsTable.classList.add('opacity-0');
        document.getElementById('stats-error').style.display = 'none';
        document.getElementById('stats-body').innerHTML = '';

        document.getElementById('player-headshot').src = '';
        document.getElementById('player-name').textContent = '';
        document.getElementById('player-details').innerHTML = '';
        document.getElementById('player-injury').innerHTML = '';
        const playerHeadshot = document.getElementById('player-headshot');
        playerHeadshot.style.display = 'none';
        playerHeadshot.src = '';
    }

    document.getElementById('player-modal').addEventListener('shown.bs.modal', function() {
        const playerId = document.getElementById('player-modal-id').textContent;
        resetModalState();

        fetch(`/player-stats/${playerId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const playerHeadshot = document.getElementById('player-headshot');
                    playerHeadshot.onload = function() {
                        playerHeadshot.style.display = 'block';
                    };
                    playerHeadshot.onerror = function() {
                        this.src = 'https://cdn.nba.com/headshots/nba/latest/1040x760/fallback.png';
                        this.style.display = 'block';
                    };
                    playerHeadshot.src = data.player.headshot;

                    document.getElementById('player-name').textContent = data.player.name;
                    document.getElementById('player-details').innerHTML = `
                        <span class="tag">#${data.player.number || 'N/A'}</span>
                        <span class="tag">${data.player.position || 'N/A'}</span>
                        <span class="tag">${data.player.team || 'N/A'}</span>
                    `;

                    const injuryEl = document.getElementById('player-injury');
                    if (data.player.injury && data.player.injury.designation) {
                        let injuryStatus = data.player.injury.designation;
                        if (data.player.injury.description) {
                            injuryStatus += ` - ${data.player.injury.description}`;
                        }
                        injuryEl.innerHTML = `
                            <span class="status-chip status-injured">${injuryStatus}</span>
                        `;
                    } else {
                        injuryEl.innerHTML = `<span class="status-chip status-healthy">Healthy</span>`;
                    }

                    if (data.games && data.games.length > 0) {
                        const statsBody = document.getElementById('stats-body');
                        statsBody.innerHTML = data.games.map(game => `
                            <tr>
                                <td>${formatGameDate(game.gameID)}</td>
                                <td>${game.mins}</td>
                                <td>${game.pts}</td>
                                <td>${game.reb}</td>
                                <td>${game.ast}</td>
                                <td>${game.stl}</td>
                                <td>${game.blk}</td>
                                <td>${game.TOV}</td>
                                <td>${game.fgp}%</td>
                            </tr>
                        `).join('');

                        const statsTable = document.getElementById('stats-table');
                        statsTable.style.display = 'block';
                        setTimeout(() => {
                            statsTable.classList.remove('opacity-0');
                        }, 50);
                    } else {
                        throw new Error('No game data available');
                    }
                } else {
                    throw new Error('Failed to fetch player data');
                }
            })
            .catch(error => {
                console.error("Error loading player stats:", error);
                document.getElementById('stats-error').textContent = error.message;
                document.getElementById('stats-error').style.display = 'block';
            })
            .finally(() => {
                document.getElementById('stats-loading').style.display = 'none';
            });
    });

    document.getElementById('player-modal').addEventListener('hidden.bs.modal', function() {
        resetModalState();
    });
</script>
