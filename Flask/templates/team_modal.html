{% for game_key in (data.get('fanduel') or {}) %}
{% set teams = game_key.split(':') %}
{% for team in teams %}
<div class="modal fade" id="modal-{{ team|replace(' ', '-')|lower }}" tabindex="-1"
    aria-labelledby="modal-{{ team|replace(' ', '-')|lower }}-label" aria-hidden="true" data-bs-backdrop="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-{{ team|replace(' ', '-')|lower }}-label">
                    {{ team }} roster
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="team-data-{{ team|replace(' ', '-')|lower }}" class="player-roster row">
                    <div class="loading-spinner text-center py-4 mt-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="player-list" style="display: none;"></div>
                    <div class="error-message text-danger text-center py-4" style="display: none;">
                        Failed to load team data
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endfor %}

<script>
    const teamDataCache = new Map();

    document.addEventListener('DOMContentLoaded', function() {
        function createPlayerCard(player) {
            const isHealthy = player.injury === 'Healthy';
            return `
                <div class="col-12 col-xl-6 mb-3">
                    <div class="player-card" onclick="showPlayerModal('${player.playerId}')">
                        <div class="d-flex align-items-start gap-3">
                            <img src="${player.headshot}"
                                 alt="${player.name}"
                                 class="player-headshot"
                                 onerror="this.src='https://cdn.nba.com/headshots/nba/latest/1040x760/fallback.png'">
                            <div class="flex-grow-1">
                                <div class="player-name">${player.name}</div>
                                <div class="tag-row">
                                    <span class="tag">#${player.jerseyNum || 'N/A'}</span>
                                    <span class="tag">${player.position || 'N/A'}</span>
                                    <span class="status-chip ${isHealthy ? 'status-healthy' : 'status-injured'}">
                                        ${isHealthy ? 'Healthy' : 'Injured'}
                                    </span>
                                </div>
                                <div class="player-meta">
                                    Height: ${player.height || 'N/A'} / Weight: ${player.weight || 'N/A'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.showPlayerModal = function(playerId) {
            const teamModal = bootstrap.Modal.getInstance(document.querySelector('.modal.show'));
            if (teamModal) {
                teamModal.hide();
            }

            setTimeout(() => {
                document.getElementById('player-modal-id').textContent = playerId;
                const playerModal = new bootstrap.Modal(document.getElementById('player-modal'));
                playerModal.show();
            }, 150);
        };

        document.querySelectorAll('.modal').forEach(function(modalElement) {
            modalElement.addEventListener('shown.bs.modal', function() {
                const teamName = this.querySelector('.modal-title').textContent.replace(' roster', '').trim();
                const teamDataContainer = this.querySelector('.player-roster');
                const loadingSpinner = teamDataContainer.querySelector('.loading-spinner');
                const playerList = teamDataContainer.querySelector('.player-list');
                const errorMessage = teamDataContainer.querySelector('.error-message');

                if (teamDataCache.has(teamName)) {
                    playerList.innerHTML = `<div class="row">${teamDataCache.get(teamName)}</div>`;
                    playerList.style.display = 'block';
                    loadingSpinner.style.display = 'none';
                    return;
                }

                loadingSpinner.style.display = 'block';
                playerList.style.display = 'none';
                errorMessage.style.display = 'none';

                fetch(`/team-data/${encodeURIComponent(teamName)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.players) {
                            const playerCards = data.players
                                .sort((a, b) => a.name.localeCompare(b.name))
                                .map(player => createPlayerCard(player))
                                .join('');
                            playerList.innerHTML = `<div class="row">${playerCards}</div>`;
                            playerList.style.display = 'block';
                            teamDataCache.set(teamName, playerCards);
                        } else {
                            throw new Error(data.error || 'Failed to load team data');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching team data:', error);
                        errorMessage.textContent = error.message;
                        errorMessage.style.display = 'block';
                    })
                    .finally(() => {
                        loadingSpinner.style.display = 'none';
                    });
            });
        });
    });
</script>
